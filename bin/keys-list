#!/bin/sh

VERBOSE=0
if [ "$1" = "-v" ]; then
  VERBOSE=1
fi

set -eu

if ! vault-loc ssh >/dev/null 2>&1; then
  echo "ssh vault not mounted" >&2
  exit 1
fi

gen_pub_key () {
  local key=$1
  if [ ! -f "${key}.pub" ]; then
    echo "missing public key for ${key}: generating..." >&2
    ssh-keygen -y -f "$key" >"${key}.pub"
  fi
}

cd "$(vault-loc ssh)"
for key in $(grep -lF -dskip 'PRIVATE KEY' *); do
  if [ "$VERBOSE" = 1 ]; then
    gen_pub_key "$key"
    ssh-keygen -l -f "${key}.pub"
  else
    echo "$key"
  fi
done
